import { HorizontalBox, VerticalBox, Button, ScrollView } from "std-widgets.slint";
import { Kolory } from "../colors.slint";
import { DraggableWindow } from "../DraggableWindow.slint";

import "../../resources/fonts/Geist-Regular.otf";
import "../../resources/fonts/Geist-Bold.otf";
import "../../resources/fonts/GeistMono-Regular.otf";

export component HistogramWindow inherits Rectangle {
    in-out property <[int]> histogram-red-data: [];
    in-out property <[int]> histogram-green-data: [];
    in-out property <[int]> histogram-blue-data: [];
    in-out property <[int]> histogram-luminance-data: [];
    in-out property <float> histogram-min-value: 0.0;
    in-out property <float> histogram-max-value: 1.0;
    in-out property <int> histogram-total-pixels: 0;
    in-out property <float> histogram-p1: 0.0;
    in-out property <float> histogram-p50: 0.5;
    in-out property <float> histogram-p99: 1.0;
    
    // Channel selection state
    in-out property <int> selected-channel: 4; // 0=Red, 1=Green, 2=Blue, 3=Luminance, 4=All Channels
    property <[int]> current-histogram-data: root.selected-channel == 0 ? root.histogram-red-data : 
                                           root.selected-channel == 1 ? root.histogram-green-data :
                                           root.selected-channel == 2 ? root.histogram-blue-data : 
                                           root.selected-channel == 3 ? root.histogram-luminance-data :
                                           root.histogram-red-data; // Dla "All Channels" używamy Red jako bazę
    
    // Wymiary kontenera i marginesy do ograniczenia ruchu
    in-out property <length> container-width: 0px;
    in-out property <length> container-height: 0px;
    in-out property <length> top-margin: 30px;
    in-out property <length> bottom-margin: 48px;
    
    callback exit();
    
    width: 800px;
    height: 600px;
    background: Kolory.tlo;
    border-color: Kolory.obramowanie;
    border-width: 1px;
    border-radius: 4px;
    
    VerticalBox {
        padding: 4px;
        spacing: 0px;
        
        DraggableWindow {
            window-title: "Histogram Analysis";
            exit => { root.exit(); }
            dragged(dx, dy) => {
                // Aktualizuj pozycję okna w granicach dostępnego obszaru
                root.x = Math.max(0px, Math.min(root.container-width - root.width, root.x + dx));
                root.y = Math.max(root.top-margin, Math.min(root.container-height - root.bottom-margin - root.height, root.y + dy));
            }
            drag-ended => { }
        }
        
        // Główna zawartość histogramu
        Rectangle {
            vertical-stretch: 1;
            background: Kolory.panel_tlo;
            border-color: Kolory.obramowanie;
            border-width: 1px;
            
            VerticalBox {
                padding: 6px;
                spacing: 6px;
                
                // Wybór kanału
                HorizontalBox {
                    spacing: 6px;
                    alignment: start;
                    
                    Rectangle {
                        width: 120px;
                        height: 24px;
                        background: channel-button-area.has-hover ? Kolory.hover : (root.selected-channel == 0 ? Kolory.obramowanie : #2a2d3a);
                        border-color: root.selected-channel == 0 ? Kolory.kanal_r : #404040;
                        border-width: root.selected-channel == 0 ? 2px : 1px;
                        border-radius: 3px;
                        
                        channel-button-area := TouchArea { 
                            clicked => { 
                                root.selected-channel = 0;
                            } 
                        }
                        
                        Text { 
                            text: "Red"; 
                            color: Kolory.tekst_silny; 
                            font-size: 12px; 
                            font-family: "Geist"; 
                            horizontal-alignment: center; 
                            vertical-alignment: center;
                            width: 100%;
                            height: 100%;
                        }
                    }
                    
                    Rectangle {
                        width: 120px;
                        height: 24px;
                        background: channel-button-area2.has-hover ? Kolory.hover : (root.selected-channel == 1 ? Kolory.obramowanie : #2a2d3a);
                        border-color: root.selected-channel == 1 ? Kolory.kanal_g : #404040;
                        border-width: root.selected-channel == 1 ? 2px : 1px;
                        border-radius: 3px;
                        
                        channel-button-area2 := TouchArea { 
                            clicked => { 
                                root.selected-channel = 1;
                            } 
                        }
                        
                        Text { 
                            text: "Green"; 
                            color: Kolory.tekst_silny; 
                            font-size: 12px; 
                            font-family: "Geist"; 
                            horizontal-alignment: center; 
                            vertical-alignment: center;
                            width: 100%;
                            height: 100%;
                        }
                    }
                    
                    Rectangle {
                        width: 120px;
                        height: 24px;
                        background: channel-button-area3.has-hover ? Kolory.hover : (root.selected-channel == 2 ? Kolory.obramowanie : #2a2d3a);
                        border-color: root.selected-channel == 2 ? Kolory.kanal_b : #404040;
                        border-width: root.selected-channel == 2 ? 2px : 1px;
                        border-radius: 3px;
                        
                        channel-button-area3 := TouchArea { 
                            clicked => { 
                                root.selected-channel = 2;
                            } 
                        }
                        
                        Text { 
                            text: "Blue"; 
                            color: Kolory.tekst_silny; 
                            font-size: 12px; 
                            font-family: "Geist"; 
                            horizontal-alignment: center; 
                            vertical-alignment: center;
                            width: 100%;
                            height: 100%;
                        }
                    }
                    
                    Rectangle {
                        width: 120px;
                        height: 24px;
                        background: channel-button-area4.has-hover ? Kolory.hover : (root.selected-channel == 3 ? Kolory.obramowanie : #2a2d3a);
                        border-color: root.selected-channel == 3 ? Kolory.tekst_silny : #404040;
                        border-width: root.selected-channel == 3 ? 2px : 1px;
                        border-radius: 3px;
                        
                        channel-button-area4 := TouchArea { 
                            clicked => { 
                                root.selected-channel = 3;
                            } 
                        }
                        
                        Text { 
                            text: "Luminance"; 
                            color: Kolory.tekst_silny; 
                            font-size: 12px; 
                            font-family: "Geist"; 
                            horizontal-alignment: center; 
                            vertical-alignment: center;
                            width: 100%;
                            height: 100%;
                        }
                    }
                     
                    Rectangle {
                        width: 120px;
                        height: 24px;
                        background: channel-button-area5.has-hover ? Kolory.hover : (root.selected-channel == 4 ? Kolory.obramowanie : #2a2d3a);
                        border-color: root.selected-channel == 4 ? Kolory.tekst_silny : #404040;
                        border-width: root.selected-channel == 4 ? 2px : 1px;
                        border-radius: 3px;
                        
                        channel-button-area5 := TouchArea { 
                            clicked => { 
                                root.selected-channel = 4;
                            } 
                        }
                        
                        Text { 
                            text: "All Channels"; 
                            color: Kolory.tekst_silny; 
                            font-size: 12px; 
                            font-family: "Geist"; 
                            horizontal-alignment: center; 
                            vertical-alignment: center;
                            width: 100%;
                            height: 100%;
                        }
                    }
                 }
                
                // Obszar histogramu
                Rectangle {
                    height: 420px;
                    background: Kolory.tlo;
                    border-color: Kolory.obramowanie;
                    border-width: 1px;
                    border-radius: 3px;
                    
                    // Histogram visualization
                    histogram-area := Rectangle {
                        width: parent.width - 16px;
                        height: parent.height - 16px;
                        x: 8px;
                        y: 8px;
                        
                        property <length> bar-width: root.current-histogram-data.length > 0 ? 
                            Math.max(0.5px, (histogram-area.width - 16px) / root.current-histogram-data.length) : 1px;
                        // Simplified max calculation - use a reasonable default for scaling
                        property <int> max-value: root.histogram-total-pixels > 0 ? root.histogram-total-pixels / 50 : 100;
                        
                        // Red channel histogram
                        for bin-value[i] in root.histogram-red-data: Rectangle {
                            x: 8px + Math.min(i * histogram-area.bar-width, histogram-area.width - histogram-area.bar-width);
                            y: Math.max(8px, histogram-area.height - 8px - (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value);
                            width: Math.max(0.5px, Math.min(histogram-area.bar-width - 0.5px, histogram-area.width - 8px - i * histogram-area.bar-width));
                            height: Math.min(histogram-area.height - 16px, Math.max(0px, (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value));
                            background: Kolory.kanal_r;
                            opacity: root.selected-channel == 0 ? 0.8 : (root.selected-channel == 4 ? 0.7 : 0);
                            border-radius: 1px;
                        }
                        
                        // Green channel histogram  
                        for bin-value[i] in root.histogram-green-data: Rectangle {
                            x: 8px + Math.min(i * histogram-area.bar-width, histogram-area.width - histogram-area.bar-width);
                            y: Math.max(8px, histogram-area.height - 8px - (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value);
                            width: Math.max(0.5px, Math.min(histogram-area.bar-width - 0.5px, histogram-area.width - 8px - i * histogram-area.bar-width));
                            height: Math.min(histogram-area.height - 16px, Math.max(0px, (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value));
                            background: Kolory.kanal_g;
                            opacity: root.selected-channel == 1 ? 0.8 : (root.selected-channel == 4 ? 0.7 : 0);
                            border-radius: 1px;
                        }
                        
                        // Blue channel histogram
                        for bin-value[i] in root.histogram-blue-data: Rectangle {
                            x: 8px + Math.min(i * histogram-area.bar-width, histogram-area.width - histogram-area.bar-width);
                            y: Math.max(8px, histogram-area.height - 8px - (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value);
                            width: Math.max(0.5px, Math.min(histogram-area.bar-width - 0.5px, histogram-area.width - 8px - i * histogram-area.bar-width));
                            height: Math.min(histogram-area.height - 16px, Math.max(0px, (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value));
                            background: Kolory.kanal_b;
                            opacity: root.selected-channel == 2 ? 0.8 : (root.selected-channel == 4 ? 0.7 : 0);
                            border-radius: 1px;
                        }
                        
                        // Luminance channel histogram
                        for bin-value[i] in root.histogram-luminance-data: Rectangle {
                            x: 8px + Math.min(i * histogram-area.bar-width, histogram-area.width - histogram-area.bar-width);
                            y: Math.max(8px, histogram-area.height - 8px - (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value);
                            width: Math.max(0.5px, Math.min(histogram-area.bar-width - 0.5px, histogram-area.width - 8px - i * histogram-area.bar-width));
                            height: Math.min(histogram-area.height - 16px, Math.max(0px, (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value));
                            background: Kolory.tekst;
                            opacity: root.selected-channel == 3 ? 0.8 : 0;
                            border-radius: 1px;
                        }
                         if root.current-histogram-data.length == 0: Text {
                            text: "No histogram data available";
                            color: Kolory.tekst_slabszy;
                            font-size: 12px;
                            font-family: "Geist";
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            width: parent.width;
                            height: parent.height;
                        }
                    }
                }
                
                // Statystyki
                HorizontalBox {
                    spacing: 32px;
                    alignment: start;
                    
                    VerticalBox {
                        spacing: 4px;
                        Text { 
                            text: "Min: " + root.histogram-min-value; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                        Text { 
                            text: "P1: " + root.histogram-p1; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                    }
                    
                    VerticalBox {
                        spacing: 4px;
                        Text { 
                            text: "P50: " + root.histogram-p50; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                        Text { 
                            text: "P99: " + root.histogram-p99; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                    }
                    
                    VerticalBox {
                        spacing: 4px;
                        Text { 
                            text: "Max: " + root.histogram-max-value; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                        Text { 
                            text: "Pixels: " + root.histogram-total-pixels; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                    }
                }
            }
        }
        
        // Dolny pasek z przyciskami
        Rectangle {
            height: 32px;
            background: Kolory.panel_tlo;
            
                    VerticalBox {
            spacing: 0px;
            padding: 0px;
                
                Rectangle { 
                    height: 1px; 
                    background: Kolory.obramowanie; 
                }
                
                HorizontalBox {
                    padding: 4px;
                    spacing: 10px;
                    alignment: center;
                    
                    Rectangle {
                        width: 80px;
                        height: 20px;
                        background: close-button-area.has-hover ? Kolory.hover : #2a2d3a;
                        border-color: #404040;
                        border-width: 1px;
                        border-radius: 3px;
                        
                        Text { 
                            text: "Close"; 
                            color: #ffffff; 
                            font-size: 12px; 
                            font-family: "Geist"; 
                            horizontal-alignment: center; 
                            vertical-alignment: center; 
                        }
                        
                        close-button-area := TouchArea { 
                            clicked => { root.exit(); } 
                        }
                    }
                }
            }
        }
    }
}
