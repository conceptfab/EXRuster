import { HorizontalBox, VerticalBox, Button, ScrollView } from "std-widgets.slint";
import { Kolory } from "../colors.slint";
import { DraggableWindow } from "../DraggableWindow.slint";

import "../../resources/fonts/Geist-Regular.otf";
import "../../resources/fonts/Geist-Bold.otf";
import "../../resources/fonts/GeistMono-Regular.otf";

export component HistogramWindow inherits Rectangle {
    in-out property <[int]> histogram-red-data: [];
    in-out property <[int]> histogram-green-data: [];
    in-out property <[int]> histogram-blue-data: [];
    in-out property <[int]> histogram-luminance-data: [];
    in-out property <float> histogram-min-value: 0.0;
    in-out property <float> histogram-max-value: 1.0;
    in-out property <int> histogram-total-pixels: 0;
    in-out property <float> histogram-p1: 0.0;
    in-out property <float> histogram-p50: 0.5;
    in-out property <float> histogram-p99: 1.0;
    
    // Channel selection state
    in-out property <int> selected-channel: 3; // 0=Red, 1=Green, 2=Blue, 3=Luminance
    property <[int]> current-histogram-data: root.selected-channel == 0 ? root.histogram-red-data : 
                                           root.selected-channel == 1 ? root.histogram-green-data :
                                           root.selected-channel == 2 ? root.histogram-blue-data : 
                                           root.histogram-luminance-data;
    
    // Wymiary kontenera i marginesy do ograniczenia ruchu
    in-out property <length> container-width: 0px;
    in-out property <length> container-height: 0px;
    in-out property <length> top-margin: 30px;
    in-out property <length> bottom-margin: 48px;
    
    callback exit();
    
    width: 800px;
    height: 600px;
    background: Kolory.tlo;
    border-color: Kolory.obramowanie;
    border-width: 1px;
    border-radius: 4px;
    
    VerticalBox {
        padding: 4px;
        spacing: 0px;
        
        DraggableWindow {
            window-title: "Histogram Analysis";
            exit => { root.exit(); }
            dragged(dx, dy) => {
                // Aktualizuj pozycję okna w granicach dostępnego obszaru
                root.x = Math.max(0px, Math.min(root.container-width - root.width, root.x + dx));
                root.y = Math.max(root.top-margin, Math.min(root.container-height - root.bottom-margin - root.height, root.y + dy));
            }
            drag-ended => { }
        }
        
        // Główna zawartość histogramu
        Rectangle {
            vertical-stretch: 1;
            background: Kolory.panel_tlo;
            border-color: Kolory.obramowanie;
            border-width: 1px;
            
            VerticalBox {
                padding: 16px;
                spacing: 16px;
                
                // Wybór kanału
                HorizontalBox {
                    spacing: 16px;
                    alignment: start;
                    
                    Rectangle {
                        width: 120px;
                        height: 24px;
                        background: channel-button-area.has-hover ? Kolory.hover : (root.selected-channel == 0 ? Kolory.panel_tlo : Kolory.suwak_tlo);
                        border-color: root.selected-channel == 0 ? Kolory.kanal_r : Kolory.suwak_tor;
                        border-width: root.selected-channel == 0 ? 2px : 1px;
                        border-radius: 3px;
                        
                        HorizontalBox {
                            spacing: 8px;
                            alignment: center;
                            
                            Rectangle {
                                width: 8px;
                                height: 8px;
                                background: Kolory.kanal_r;
                                border-radius: 4px;
                            }
                            Text { 
                                text: "Red"; 
                                color: root.selected-channel == 0 ? Kolory.kanal_r : Kolory.tekst; 
                                font-size: 11px; 
                                font-family: "Geist"; 
                                horizontal-alignment: center; 
                                vertical-alignment: center; 
                            }
                        }
                        
                        channel-button-area := TouchArea { 
                            clicked => { 
                                root.selected-channel = 0;
                            } 
                        }
                    }
                    
                    Rectangle {
                        width: 120px;
                        height: 24px;
                        background: channel-button-area2.has-hover ? Kolory.hover : (root.selected-channel == 1 ? Kolory.panel_tlo : Kolory.suwak_tlo);
                        border-color: root.selected-channel == 1 ? Kolory.kanal_g : Kolory.suwak_tor;
                        border-width: root.selected-channel == 1 ? 2px : 1px;
                        border-radius: 3px;
                        
                        HorizontalBox {
                            spacing: 8px;
                            alignment: center;
                            
                            Rectangle {
                                width: 8px;
                                height: 8px;
                                background: Kolory.kanal_g;
                                border-radius: 4px;
                            }
                            Text { 
                                text: "Green"; 
                                color: root.selected-channel == 1 ? Kolory.kanal_g : Kolory.tekst; 
                                font-size: 11px; 
                                font-family: "Geist"; 
                                horizontal-alignment: center; 
                                vertical-alignment: center; 
                            }
                        }
                        
                        channel-button-area2 := TouchArea { 
                            clicked => { 
                                root.selected-channel = 1;
                            } 
                        }
                    }
                    
                    Rectangle {
                        width: 120px;
                        height: 24px;
                        background: channel-button-area3.has-hover ? Kolory.hover : (root.selected-channel == 2 ? Kolory.panel_tlo : Kolory.suwak_tlo);
                        border-color: root.selected-channel == 2 ? Kolory.kanal_b : Kolory.suwak_tor;
                        border-width: root.selected-channel == 2 ? 2px : 1px;
                        border-radius: 3px;
                        
                        HorizontalBox {
                            spacing: 8px;
                            alignment: center;
                            
                            Rectangle {
                                width: 8px;
                                height: 8px;
                                background: Kolory.kanal_b;
                                border-radius: 4px;
                            }
                            Text { 
                                text: "Blue"; 
                                color: root.selected-channel == 2 ? Kolory.kanal_b : Kolory.tekst; 
                                font-size: 11px; 
                                font-family: "Geist"; 
                                horizontal-alignment: center; 
                                vertical-alignment: center; 
                            }
                        }
                        
                        channel-button-area3 := TouchArea { 
                            clicked => { 
                                root.selected-channel = 2;
                            } 
                        }
                    }
                    
                    Rectangle {
                        width: 120px;
                        height: 24px;
                        background: channel-button-area4.has-hover ? Kolory.hover : (root.selected-channel == 3 ? Kolory.panel_tlo : Kolory.suwak_tlo);
                        border-color: root.selected-channel == 3 ? Kolory.tekst : Kolory.suwak_tor;
                        border-width: root.selected-channel == 3 ? 2px : 1px;
                        border-radius: 3px;
                        
                        HorizontalBox {
                            spacing: 8px;
                            alignment: center;
                            
                            Rectangle {
                                width: 8px;
                                height: 8px;
                                background: Kolory.tekst;
                                border-radius: 4px;
                            }
                            Text { 
                                text: "Luminance"; 
                                color: Kolory.tekst; 
                                font-size: 11px; 
                                font-family: "Geist"; 
                                horizontal-alignment: center; 
                                vertical-alignment: center; 
                            }
                        }
                        
                        channel-button-area4 := TouchArea { 
                            clicked => { 
                                root.selected-channel = 3;
                            } 
                        }
                    }
                }
                
                // Obszar histogramu
                Rectangle {
                    height: 300px;
                    background: Kolory.tlo;
                    border-color: Kolory.obramowanie;
                    border-width: 1px;
                    border-radius: 3px;
                    
                    // Histogram visualization
                    histogram-area := Rectangle {
                        width: parent.width - 16px;
                        height: parent.height - 16px;
                        x: 8px;
                        y: 8px;
                        
                        property <length> bar-width: root.current-histogram-data.length > 0 ? 
                            (histogram-area.width - 16px) / root.current-histogram-data.length : 1px;
                        // Simplified max calculation - use a reasonable default for scaling
                        property <int> max-value: root.histogram-total-pixels > 0 ? root.histogram-total-pixels / 50 : 100;
                        
                        for bin-value[i] in root.current-histogram-data: Rectangle {
                            x: 8px + i * histogram-area.bar-width;
                            y: histogram-area.height - 8px - (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value;
                            width: Math.max(1px, histogram-area.bar-width - 1px);
                            height: (bin-value * (histogram-area.height - 16px)) / histogram-area.max-value;
                            background: root.selected-channel == 0 ? Kolory.kanal_r :
                                       root.selected-channel == 1 ? Kolory.kanal_g :
                                       root.selected-channel == 2 ? Kolory.kanal_b :
                                       Kolory.tekst;
                            opacity: histogram-bar-touch.has-hover ? 1.0 : 0.8;
                            border-radius: 1px;
                            
                            histogram-bar-touch := TouchArea {
                                if self.has-hover: Rectangle {
                                    z: 1000;
                                    x: parent.width / 2 - self.width / 2;
                                    y: -32px;
                                    width: 120px;
                                    height: 24px;
                                    background: Kolory.panel_tlo;
                                    border-color: Kolory.obramowanie;
                                    border-width: 1px;
                                    border-radius: 4px;
                                    
                                    Text {
                                        text: "Bin " + i + ": " + bin-value;
                                        color: Kolory.tekst;
                                        font-size: 10px;
                                        font-family: "Geist";
                                        horizontal-alignment: center;
                                        vertical-alignment: center;
                                        width: parent.width;
                                        height: parent.height;
                                    }
                                }
                            }
                        }
                        
                        if root.current-histogram-data.length == 0: Text {
                            text: "No histogram data available";
                            color: Kolory.tekst_slabszy;
                            font-size: 12px;
                            font-family: "Geist";
                            horizontal-alignment: center;
                            vertical-alignment: center;
                            width: parent.width;
                            height: parent.height;
                        }
                    }
                }
                
                // Statystyki
                HorizontalBox {
                    spacing: 32px;
                    alignment: start;
                    
                    VerticalBox {
                        spacing: 4px;
                        Text { 
                            text: "Min: " + root.histogram-min-value; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                        Text { 
                            text: "P1: " + root.histogram-p1; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                    }
                    
                    VerticalBox {
                        spacing: 4px;
                        Text { 
                            text: "P50: " + root.histogram-p50; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                        Text { 
                            text: "P99: " + root.histogram-p99; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                    }
                    
                    VerticalBox {
                        spacing: 4px;
                        Text { 
                            text: "Max: " + root.histogram-max-value; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                        Text { 
                            text: "Pixels: " + root.histogram-total-pixels; 
                            color: Kolory.tekst; 
                            font-size: 11px;
                            font-family: "Geist";
                        }
                    }
                }
            }
        }
        
        // Dolny pasek z przyciskami
        Rectangle {
            height: 32px;
            background: Kolory.panel_tlo;
            
                    VerticalBox {
            spacing: 0px;
            padding: 0px;
                
                Rectangle { 
                    height: 1px; 
                    background: Kolory.obramowanie; 
                }
                
                HorizontalBox {
                    padding: 4px;
                    spacing: 10px;
                    alignment: center;
                    
                    Rectangle {
                        width: 80px;
                        height: 20px;
                        background: close-button-area.has-hover ? Kolory.hover : Kolory.suwak_tlo;
                        border-color: Kolory.suwak_tor;
                        border-width: 1px;
                        border-radius: 3px;
                        
                        Text { 
                            text: "Close"; 
                            color: Kolory.tekst; 
                            font-size: 10px; 
                            font-family: "Geist"; 
                            horizontal-alignment: center; 
                            vertical-alignment: center; 
                        }
                        
                        close-button-area := TouchArea { 
                            clicked => { root.exit(); } 
                        }
                    }
                }
            }
        }
    }
}
